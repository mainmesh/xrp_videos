{% extends "base.html" %}
{% load video_filters %}
{% block title %}Videos — Browse{% endblock %}
{% block content %}
  <h2 class="text-4xl font-bold gradient-text mb-12 slide-in-up">Browse Videos</h2>
  
  <div class="flex items-center justify-between mb-6 gap-4">
    <div class="flex items-center gap-3">
      <a href="?available=1" class="px-3 py-1 rounded bg-purple-600 text-white text-sm">Available for you</a>
      <a href="?" class="px-3 py-1 rounded bg-slate-800 text-gray-300 text-sm">Show all</a>
    </div>
    <div class="text-sm text-gray-400">Compact grid — tap a card to preview</div>
  </div>
  
  <!-- Compact modal for preview -->
  <div id="video-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60">
    <div class="bg-slate-900 rounded-lg w-full max-w-3xl mx-4 overflow-hidden">
      <div class="p-4 flex items-center justify-between border-b border-slate-800">
        <div id="modal-title" class="font-semibold text-white">Preview</div>
        <button id="modal-close" class="text-gray-400">Close</button>
      </div>
      <div class="aspect-video bg-black relative" id="modal-body">
        <!-- iframe injected here -->
        <div id="embed-error" class="hidden absolute inset-0 flex flex-col items-center justify-center bg-slate-900 text-white p-8">
          <svg class="w-16 h-16 mb-4 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          <p class="text-lg mb-4">This video cannot be embedded</p>
          <a id="youtube-link" href="#" target="_blank" class="px-6 py-3 bg-red-600 hover:bg-red-700 rounded-lg transition">
            Watch on YouTube
          </a>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Convert YouTube URLs to embed format with proper parameters
    function youtubeEmbed(url) {
      const patterns = [
        /(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/,
        /youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/,
        /youtube\.com\/v\/([a-zA-Z0-9_-]{11})/
      ];
      for (const pattern of patterns) {
        const match = url.match(pattern);
        if (match) {
          const videoId = match[1];
          // Use simple parameters without origin/referrer to avoid Error 153
          return 'https://www.youtube.com/embed/' + videoId + '?autoplay=1&rel=0&modestbranding=1&playsinline=1';
        }
      }
      return url;
    }

    document.addEventListener('click', function(e){
      const card = e.target.closest('.video-card');
      if(card){
        const originalUrl = card.dataset.videoUrl;
        const embedUrl = youtubeEmbed(originalUrl);
        const title = card.dataset.videoTitle;
        const modal = document.getElementById('video-modal');
        const body = document.getElementById('modal-body');
        const mt = document.getElementById('modal-title');
        const errorDiv = document.getElementById('embed-error');
        const youtubeLink = document.getElementById('youtube-link');
        
        mt.textContent = title;
        errorDiv.classList.add('hidden');
        
        // Create iframe with error detection
        const iframe = document.createElement('iframe');
        iframe.src = embedUrl;
        iframe.className = 'w-full h-full';
        iframe.setAttribute('frameborder', '0');
        iframe.setAttribute('allow', 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share');
        iframe.setAttribute('allowfullscreen', 'true');
        iframe.setAttribute('loading', 'lazy');
        
        // Listen for load errors
        iframe.onerror = function() {
          errorDiv.classList.remove('hidden');
          youtubeLink.href = originalUrl;
        };
        
        // Detect YouTube embed errors after a delay
        setTimeout(function() {
          try {
            // If iframe content is blocked, show fallback
            if (!iframe.contentWindow || iframe.contentWindow.length === 0) {
              errorDiv.classList.remove('hidden');
              youtubeLink.href = originalUrl;
            }
          } catch(e) {
            // Cross-origin errors are expected, ignore them
          }
        }, 2000);
        
        body.innerHTML = '';
        body.appendChild(iframe);
        modal.classList.remove('hidden');
        modal.classList.add('flex');
      }
      if(e.target.id === 'modal-close' || e.target.id === 'video-modal'){
        const modal = document.getElementById('video-modal');
        modal.classList.remove('flex'); modal.classList.add('hidden');
        document.getElementById('modal-body').innerHTML = '';
      }
    });
  </script>

  <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
    {% for v in videos %}
    <div class="video-card group cursor-pointer" data-video-id="{{ v.id }}" data-video-url="{{ v.url }}" data-video-title="{{ v.title|escapejs }}">
      <!-- Video Thumbnail with Play Overlay -->
      <div class="relative rounded-lg overflow-hidden aspect-video bg-slate-900 mb-2 shadow-lg hover:shadow-2xl transition-all duration-300">
        {% if v.thumbnail_url %}
          <img src="{{ v.thumbnail_url }}" alt="{{ v.title }}" class="w-full h-full object-cover" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
          <!-- YouTube Thumbnail Fallback if custom thumbnail fails -->
          <img src="{{ v.url|youtube_thumbnail:'hqdefault' }}" alt="{{ v.title }}" class="w-full h-full object-cover hidden" onerror="this.src='{{ v.url|youtube_thumbnail:'mqdefault' }}';" />
        {% else %}
          <!-- Direct YouTube Thumbnail (hqdefault is always available) -->
          <img src="{{ v.url|youtube_thumbnail:'hqdefault' }}" alt="{{ v.title }}" class="w-full h-full object-cover" onerror="this.src='{{ v.url|youtube_thumbnail:'mqdefault' }}';" />
        {% endif %}
        
        <!-- Dark Overlay on Hover -->
        <div class="absolute inset-0 bg-black/0 group-hover:bg-black/40 transition-all duration-300"></div>
        
        <!-- Play Button Overlay -->
        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all duration-300 transform group-hover:scale-110">
          <div class="w-12 h-12 bg-white/90 rounded-full flex items-center justify-center shadow-2xl">
            <svg class="w-6 h-6 text-purple-600 ml-0.5" fill="currentColor" viewBox="0 0 20 20">
              <path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z"/>
            </svg>
          </div>
        </div>
        
        <!-- Duration Badge -->
        <div class="absolute bottom-1.5 right-1.5 px-1.5 py-0.5 bg-black/80 backdrop-blur-sm rounded text-xs font-semibold text-white">
          {{ v.duration_minutes }}m
        </div>
        
        <!-- Reward Badge -->
        <div class="absolute top-1.5 right-1.5 px-2 py-0.5 bg-green-500/90 backdrop-blur-sm rounded-full text-xs font-bold text-white shadow-lg">
          ${% get_video_reward v user_tier %}
        </div>
      </div>
      
      <!-- Video Info -->
      <div class="px-1">
        <h3 class="text-sm font-semibold text-white mb-1 line-clamp-2 leading-tight group-hover:text-purple-300 transition">
          {{ v.title }}
        </h3>
        
        {% if v.category %}
        <span class="inline-block px-2 py-0.5 bg-purple-500/20 rounded text-xs text-purple-300 mt-1">
          {{ v.category.name }}
        </span>
        {% endif %}
      </div>
    </div>
    {% empty %}
      <div class="col-span-4 text-center py-12">
        <svg class="w-20 h-20 mx-auto mb-4 text-purple-400/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
        </svg>
        <p class="text-gray-400 text-lg">No videos available yet. Check back soon!</p>
      </div>
    {% endfor %}
  </div>
{% endblock %}
