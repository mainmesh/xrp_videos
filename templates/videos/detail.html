{% extends "base.html" %}
{% load video_filters %}
{% block title %}{{ video.title }} ‚Äî Watch{% endblock %}
{% block content %}
  <div class="max-w-4xl mx-auto">
    <!-- Video Info Header -->
    <div class="dark-glass rounded-2xl p-8 border border-purple-500/30 mb-8">
      <h2 class="text-4xl font-bold gradient-text mb-4">{{ video.title }}</h2>
      <div class="flex flex-wrap items-center gap-6 text-sm">
        <div>
          <span class="text-gray-400">Reward</span>
          <div class="text-2xl font-bold text-green-400">${{ video.reward }}</div>
        </div>
        <div>
          <span class="text-gray-400">Duration</span>
          <div class="text-2xl font-bold text-purple-300">{{ video.duration_minutes }}m</div>
        </div>
        {% if video.category %}
        <div class="inline-block px-3 py-1 bg-purple-500/20 border border-purple-500/50 rounded-full text-xs text-purple-300">
          {{ video.category.name }}
        </div>
        {% endif %}
        {% if required_tier %}
        <div class="inline-block px-3 py-1 bg-amber-500/20 border border-amber-500/50 rounded-full text-xs text-amber-300">
          üîí {{ required_tier.name }} Tier
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Access Check -->
    {% if not has_access %}
      <div class="dark-glass rounded-2xl p-8 border border-red-500/30 mb-8">
        <div class="flex items-start gap-4">
          <div class="text-4xl">üîí</div>
          <div>
            <h3 class="text-2xl font-bold text-red-300 mb-3">Premium Content</h3>
            <p class="text-gray-300 mb-6">This video requires <strong>{{ required_tier.name }}</strong> tier access.</p>
            
            {% if user.is_authenticated %}
              <p class="text-gray-400 mb-6">
                Your current tier: <strong>
                  {% if user_tier %}
                    {{ user_tier.name }}
                  {% else %}
                    Bronze (Free)
                  {% endif %}
                </strong>
              </p>
              <a href="{% url 'accounts:deposit' %}" class="inline-block px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold rounded-lg transition">
                Upgrade Your Tier üí≥
              </a>
            {% else %}
              <a href="{% url 'login' %}" class="inline-block px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold rounded-lg transition">
                Log In to Upgrade üîë
              </a>
            {% endif %}
          </div>
        </div>
      </div>
    {% else %}
      <!-- Video Player -->
      <div class="dark-glass rounded-2xl overflow-hidden border border-purple-500/30 mb-8">
        <div class="relative bg-slate-900 aspect-video flex items-center justify-center">
          <iframe 
            src="{{ video.url|youtube_embed }}" 
            class="w-full h-full" 
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
            referrerpolicy="strict-origin-when-cross-origin"
            allowfullscreen
            loading="lazy">
          </iframe>
        </div>
      </div>
      <!-- Watch Timer & Controls -->
      {% if user.is_authenticated %}
        <div class="mb-6">
          <p class="text-gray-400 text-sm mb-2">‚è±Ô∏è Watch Progress</p>
          <div class="flex items-center gap-4">
            <div class="flex-1">
              <div class="h-2 bg-slate-800/50 rounded-full overflow-hidden">
                <div id="progress-bar" class="h-full bg-gradient-to-r from-purple-600 to-pink-600 rounded-full transition-all duration-300" style="width: 0%"></div>
              </div>
            </div>
            <div class="text-right">
              <span id="watch-timer" class="text-2xl font-bold text-white">00:00</span>
              <span class="text-gray-400"> / <span id="total-duration">{{ video.duration_seconds }}</span></span>
            </div>
          </div>
        </div>

        <form id="watch-complete" method="post" action="{% url 'videos:complete' video.id %}">
          {% csrf_token %}
          <input type="hidden" id="watched-seconds-input" name="watched_seconds" value="0">
          <button type="submit" id="submit-btn" class="w-full px-6 py-4 bg-slate-700 text-gray-300 font-bold rounded-lg cursor-not-allowed transition disabled:opacity-50" disabled>
            ‚è≥ Watch the video to claim your reward...
          </button>
        </form>

        <p class="text-xs text-gray-500 text-center mt-4">Complete the full video to unlock your reward</p>
      {% else %}
        <div class="dark-glass rounded-2xl p-8 border border-purple-500/30 text-center">
          <p class="text-gray-300 mb-4">Sign in to earn rewards for watching</p>
          <a href="{% url 'login' %}" class="inline-block px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold rounded-lg transition">
            Log In Now üîë
          </a>
        </div>
      {% endif %}

      <script>
        // Client-side watch verification: timer + auto-submit
        const videoDuration = {{ video.duration_seconds }}; // seconds
        function formatTime(s) {
          const mins = Math.floor(s / 60);
          const secs = Math.floor(s % 60);
          return String(mins).padStart(2,'0') + ':' + String(secs).padStart(2,'0');
        }
        // set total duration display nicely
        const totalDurationElem = document.getElementById('total-duration');
        if (totalDurationElem) {
          const total = parseInt(totalDurationElem.textContent || '0', 10);
          totalDurationElem.textContent = formatTime(total);
        }
        const watchTimer = document.getElementById('watch-timer');
        const progressBar = document.getElementById('progress-bar');
        const submitBtn = document.getElementById('submit-btn');
        const watchForm = document.getElementById('watch-complete');
        const watchedSecondsInput = document.getElementById('watched-seconds-input');
        let watchedSeconds = 0;
        
        // Heartbeat: POST to server every 10s and increment timer every second
        function sendHeartbeat(sec){
          fetch("{% url 'videos:heartbeat' %}", {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({seconds: sec, video_id: {{ video.id }}})
          }).catch(()=>{});
        }

        setInterval(() => {
          if (watchedSeconds < videoDuration) {
            watchedSeconds += 1;
            watchTimer.textContent = formatTime(watchedSeconds);
            
            // Update hidden input
            if (watchedSecondsInput) {
              watchedSecondsInput.value = watchedSeconds;
            }
            
            // Update progress bar
            const percentage = (watchedSeconds / videoDuration) * 100;
            progressBar.style.width = percentage + '%';
          }
          
          // Send heartbeat every 10 seconds
          if (watchedSeconds % 10 === 0) sendHeartbeat(watchedSeconds);

          // Enable submit button when full duration watched
          if (watchedSeconds >= videoDuration) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('bg-slate-700', 'text-gray-300', 'cursor-not-allowed');
            submitBtn.classList.add('bg-gradient-to-r', 'from-green-600', 'to-emerald-600', 'hover:from-green-500', 'hover:to-emerald-500', 'cursor-pointer');
            submitBtn.textContent = '‚úì Claim Your Reward! üéâ';
            
            // Auto-submit after a brief delay
            setTimeout(() => {
              if (watchForm) watchForm.submit();
            }, 500);
          }
        }, 1000);
      </script>
    {% endif %}
  </div>
{% endblock %}
