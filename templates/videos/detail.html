{% extends "base.html" %}
{% load video_filters %}
{% block title %}{{ video.title }} ‚Äî Watch{% endblock %}
{% block content %}
  <div class="max-w-4xl mx-auto">
    <!-- Video Info Header -->
    <div class="dark-glass rounded-2xl p-8 border border-purple-500/30 mb-8">
      <h2 class="text-4xl font-bold gradient-text mb-4">{{ video.title }}</h2>
      <div class="flex flex-wrap items-center gap-6 text-sm">
        <div>
          <span class="text-gray-400">Reward</span>
          <div class="text-2xl font-bold text-green-400">${{ video.reward }}</div>
        </div>
        <div>
          <span class="text-gray-400">Duration</span>
          <div class="text-2xl font-bold text-purple-300">{{ video.duration_minutes }}m</div>
        </div>
        {% if video.category %}
        <div class="inline-block px-3 py-1 bg-purple-500/20 border border-purple-500/50 rounded-full text-xs text-purple-300">
          {{ video.category.name }}
        </div>
        {% endif %}
        {% if required_tier %}
        <div class="inline-block px-3 py-1 bg-amber-500/20 border border-amber-500/50 rounded-full text-xs text-amber-300">
          üîí {{ required_tier.name }} Tier
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Access Check -->
    {% if not has_access %}
      <div class="dark-glass rounded-2xl p-8 border border-red-500/30 mb-8">
        <div class="flex items-start gap-4">
          <div class="text-4xl">üîí</div>
          <div>
            <h3 class="text-2xl font-bold text-red-300 mb-3">Premium Content</h3>
            <p class="text-gray-300 mb-6">This video requires <strong>{{ required_tier.name }}</strong> tier access.</p>
            
            {% if user.is_authenticated %}
              <p class="text-gray-400 mb-6">
                Your current tier: <strong>
                  {% if user_tier %}
                    {{ user_tier.name }}
                  {% else %}
                    Bronze (Free)
                  {% endif %}
                </strong>
              </p>
              <a href="{% url 'accounts:deposit' %}" class="inline-block px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold rounded-lg transition">
                Upgrade Your Tier üí≥
              </a>
            {% else %}
              <a href="{% url 'login' %}" class="inline-block px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold rounded-lg transition">
                Log In to Upgrade üîë
              </a>
            {% endif %}
          </div>
        </div>
      </div>
    {% else %}
      <!-- Video Player -->
      <div class="dark-glass rounded-2xl overflow-hidden border border-purple-500/30 mb-8">
        <div class="relative bg-slate-900 aspect-video flex items-center justify-center">
          <iframe 
            src="{{ video.url|youtube_embed }}" 
            class="w-full h-full" 
            frameborder="0"
            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
            referrerpolicy="strict-origin-when-cross-origin"
            allowfullscreen
            loading="lazy">
          </iframe>
        </div>
      </div>
      
      {% if already_watched %}
        <!-- Already Watched Message -->
        <div class="dark-glass rounded-2xl p-8 border border-green-500/30 mb-8 text-center">
          <div class="flex items-center justify-center mb-4">
            <svg class="w-16 h-16 text-green-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
          </div>
          <h3 class="text-2xl font-bold text-green-300 mb-3">‚úì Already Watched</h3>
          <p class="text-gray-300 mb-6">You have already completed this video and received your reward.</p>
          <a href="{% url 'videos:list' %}?available=1" class="inline-block px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold rounded-lg transition">
            Browse More Videos ‚Üí
          </a>
        </div>
      {% else %}
      <!-- Watch Timer & Controls -->
      {% if user.is_authenticated %}
        <div class="mb-6">
          <p class="text-gray-400 text-sm mb-2">‚è±Ô∏è Watch Progress</p>
          <div class="flex items-center gap-4">
            <div class="flex-1">
              <div class="h-2 bg-slate-800/50 rounded-full overflow-hidden">
                <div id="progress-bar" class="h-full bg-gradient-to-r from-purple-600 to-pink-600 rounded-full transition-all duration-300" style="width: 0%"></div>
              </div>
            </div>
            <div class="text-right">
              <span id="watch-timer" class="text-2xl font-bold text-white">00:00</span>
              <span class="text-gray-400"> / <span id="total-duration">{{ video.duration_seconds }}</span></span>
            </div>
          </div>
        </div>

        <form id="watch-complete" method="post" action="{% url 'videos:complete' video.id %}">
          {% csrf_token %}
          <input type="hidden" id="watched-seconds-input" name="watched_seconds" value="0">
          <button type="submit" id="submit-btn" class="w-full px-6 py-4 bg-slate-700 text-gray-300 font-bold rounded-lg cursor-not-allowed transition disabled:opacity-50" disabled>
            ‚è≥ Watch the video to claim your reward...
          </button>
        </form>

        <p class="text-xs text-gray-500 text-center mt-4">Complete the full video to unlock your reward</p>
        
        <!-- Success Modal -->
        <div id="success-modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
          <div class="bg-gradient-to-br from-slate-900 to-purple-900 rounded-2xl p-8 max-w-md w-full text-center border border-green-500/30 shadow-2xl">
            <div class="mb-4">
              <svg class="w-20 h-20 mx-auto text-green-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
            </div>
            <h3 class="text-3xl font-bold text-white mb-2">üéâ Congratulations!</h3>
            <p class="text-gray-300 mb-4">You've earned</p>
            <p id="reward-amount" class="text-5xl font-bold text-green-400 mb-6">$0.00</p>
            <p class="text-gray-400 text-sm mb-6">The reward has been added to your account balance.</p>
            <div class="flex gap-3">
              <a href="{% url 'videos:list' %}?available=1" class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold rounded-lg transition">
                Watch More Videos ‚Üí
              </a>
              <a href="{% url 'accounts:dashboard' %}" class="flex-1 px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white font-bold rounded-lg transition">
                View Balance
              </a>
            </div>
          </div>
        </div>
      {% else %}
        <div class="dark-glass rounded-2xl p-8 border border-purple-500/30 text-center">
          <p class="text-gray-300 mb-4">Sign in to earn rewards for watching</p>
          <a href="{% url 'login' %}" class="inline-block px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white font-bold rounded-lg transition">
            Log In Now üîë
          </a>
        </div>
      {% endif %}

      <script>
        // Client-side watch verification: timer + auto-submit
        const videoDuration = {{ video.duration_seconds }}; // seconds
        function formatTime(s) {
          const mins = Math.floor(s / 60);
          const secs = Math.floor(s % 60);
          return String(mins).padStart(2,'0') + ':' + String(secs).padStart(2,'0');
        }
        // set total duration display nicely
        const totalDurationElem = document.getElementById('total-duration');
        if (totalDurationElem) {
          const total = parseInt(totalDurationElem.textContent || '0', 10);
          totalDurationElem.textContent = formatTime(total);
        }
        const watchTimer = document.getElementById('watch-timer');
        const progressBar = document.getElementById('progress-bar');
        const submitBtn = document.getElementById('submit-btn');
        const watchForm = document.getElementById('watch-complete');
        const watchedSecondsInput = document.getElementById('watched-seconds-input');
        let watchedSeconds = 0;
        
        // Heartbeat: POST to server every 10s and increment timer every second
        function sendHeartbeat(sec){
          fetch("{% url 'videos:heartbeat' %}", {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({seconds: sec, video_id: {{ video.id }}})
          }).catch(()=>{});
        }

        setInterval(() => {
          if (watchedSeconds < videoDuration) {
            watchedSeconds += 1;
            watchTimer.textContent = formatTime(watchedSeconds);
            
            // Update hidden input
            if (watchedSecondsInput) {
              watchedSecondsInput.value = watchedSeconds;
            }
            
            // Update progress bar
            const percentage = (watchedSeconds / videoDuration) * 100;
            progressBar.style.width = percentage + '%';
          }
          
          // Send heartbeat every 10 seconds
          if (watchedSeconds % 10 === 0) sendHeartbeat(watchedSeconds);

          // Enable submit button when full duration watched
          if (watchedSeconds >= videoDuration) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('bg-slate-700', 'text-gray-300', 'cursor-not-allowed');
            submitBtn.classList.add('bg-gradient-to-r', 'from-green-600', 'to-emerald-600', 'hover:from-green-500', 'hover:to-emerald-500', 'cursor-pointer');
            submitBtn.textContent = '‚úì Claim Your Reward! üéâ';
            
            // Auto-submit after a brief delay via AJAX
            setTimeout(() => {
              submitReward();
            }, 500);
          }
        }, 1000);
        
        // Submit reward via AJAX
        function submitReward() {
          const formData = new FormData(watchForm);
          
          fetch(watchForm.action, {
            method: 'POST',
            body: formData,
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            }
          })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'credited') {
              // Show success modal with reward amount
              document.getElementById('reward-amount').textContent = '$' + parseFloat(data.reward).toFixed(2);
              document.getElementById('success-modal').classList.remove('hidden');
              
              // Redirect to videos list after 5 seconds
              setTimeout(() => {
                window.location.href = '{% url "videos:list" %}?available=1';
              }, 5000);
            } else if (data.error) {
              alert('Error: ' + (data.message || data.error));
            }
          })
          .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while claiming your reward. Please try again.');
          });
        }
        
        // Prevent default form submission, use AJAX instead
        watchForm.addEventListener('submit', function(e) {
          e.preventDefault();
          submitReward();
        });
      </script>
      {% endif %}
    {% endif %}
  </div>
{% endblock %}
